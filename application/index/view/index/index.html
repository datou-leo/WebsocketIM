<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="__STATIC__/css/main.css" type="text/css" />
</head>
<body>
<div class="container">
    <button id="btnRight">右</button>
</div>

<div class="wrap">
    <div class="layer-right">

        <div class="session">
            <div class="panel">

                <header class="panel-header">
                    <span  class="panel-title">会话列表</span>
                </header>


                        <ul class="user-list" >
                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                                <!--<div class="avatar" >-->
                                    <!--<img src="__STATIC__/img/girl.jpeg">-->
                                <!--</div>-->
                                <!--<p class="nick-name">张飞<i class='badge'>1</i></p>-->
                            <!--</li>-->

                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                                <!--<div class="avatar" >-->
                                    <!--<img src="__STATIC__/img/girl.jpeg">-->
                                <!--</div>-->
                                <!--<p class="nick-name">关羽<i class='badge'>1</i></p>-->
                            <!--</li>-->

                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                                <!--<div class="avatar" >-->
                                    <!--<img src="__STATIC__/img/girl.jpeg">-->
                                <!--</div>-->
                                <!--<p class="nick-name">刘备<i class='badge'>2</i></p>-->
                            <!--</li>-->

                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                                <!--<div class="avatar" >-->
                                    <!--<img src="__STATIC__/img/girl.jpeg">-->
                                <!--</div>-->
                                <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->

                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                            <!--<div class="avatar" >-->
                            <!--<img src="__STATIC__/img/girl.jpeg">-->
                            <!--</div>-->
                            <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->


                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                            <!--<div class="avatar" >-->
                            <!--<img src="__STATIC__/img/girl.jpeg">-->
                            <!--</div>-->
                            <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->


                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                            <!--<div class="avatar" >-->
                            <!--<img src="__STATIC__/img/girl.jpeg">-->
                            <!--</div>-->
                            <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->

                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                            <!--<div class="avatar" >-->
                            <!--<img src="__STATIC__/img/girl.jpeg">-->
                            <!--</div>-->
                            <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->


                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                            <!--<div class="avatar" >-->
                            <!--<img src="__STATIC__/img/girl.jpeg">-->
                            <!--</div>-->
                            <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->


                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                            <!--<div class="avatar" >-->
                            <!--<img src="__STATIC__/img/girl.jpeg">-->
                            <!--</div>-->
                            <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->


                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                            <!--<div class="avatar" >-->
                            <!--<img src="__STATIC__/img/girl.jpeg">-->
                            <!--</div>-->
                            <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->

                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                            <!--<div class="avatar" >-->
                            <!--<img src="__STATIC__/img/girl.jpeg">-->
                            <!--</div>-->
                            <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->

                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                            <!--<div class="avatar" >-->
                            <!--<img src="__STATIC__/img/girl.jpeg">-->
                            <!--</div>-->
                            <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->


                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                            <!--<div class="avatar" >-->
                            <!--<img src="__STATIC__/img/girl.jpeg">-->
                            <!--</div>-->
                            <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->


                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                            <!--<div class="avatar" >-->
                            <!--<img src="__STATIC__/img/girl.jpeg">-->
                            <!--</div>-->
                            <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->

                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                            <!--<div class="avatar" >-->
                            <!--<img src="__STATIC__/img/girl.jpeg">-->
                            <!--</div>-->
                            <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->

                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                            <!--<div class="avatar" >-->
                            <!--<img src="__STATIC__/img/girl.jpeg">-->
                            <!--</div>-->
                            <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->


                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                            <!--<div class="avatar" >-->
                            <!--<img src="__STATIC__/img/girl.jpeg">-->
                            <!--</div>-->
                            <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->


                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                            <!--<div class="avatar" >-->
                            <!--<img src="__STATIC__/img/girl.jpeg">-->
                            <!--</div>-->
                            <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->

                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                            <!--<div class="avatar" >-->
                            <!--<img src="__STATIC__/img/girl.jpeg">-->
                            <!--</div>-->
                            <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->

                            <!--<li  class="list-item  123456"  data-user="123456" >-->
                            <!--<div class="avatar" >-->
                            <!--<img src="__STATIC__/img/girl.jpeg">-->
                            <!--</div>-->
                            <!--<p class="nick-name">刘备</p>-->
                            <!--</li>-->







                        </ul>

            </div>
        </div>


            <div class="panel chat-panel">
                <header class="panel-header">
                    <span  class="panel-title">请点击头像开始聊天..</span>
                    <input type="hidden" name="name"  id="towho" value=""/>
                </header>

                <div class="panel-body-container" >
                    <div  class="panel-body chat-container" >

                        当前没有可以聊天的好友在线请耐心等待！
                        <!--<div class="myself" ><span><img class="myimg" src="__STATIC__/img/girl.jpeg" ></span><span><p class="nick-name">张飞</p><p class="chat-content">你好，刘备</p></span></div>-->
                        <!--<div class="buddy "><span><img class="avatar" src="__STATIC__/img/girl.jpeg" ></span><span><p class="nick-name">刘备</p><p class="chat-content">你好，张飞</p></span></div>-->

                        <!--<div class="myself" ><span><img class="myimg" src="__STATIC__/img/girl.jpeg" ></span><span><p class="nick-name">张飞</p><p class="chat-content">你好，刘备</p></span></div>-->
                        <!--<div class="buddy "><span><img class="avatar" src="__STATIC__/img/girl.jpeg" ></span><span><p class="nick-name">刘备</p><p class="chat-content">你好，张飞</p></span></div>-->

                        <!--<div class="myself" ><span><img class="myimg" src="__STATIC__/img/girl.jpeg" ></span><span><p class="nick-name">张飞</p><p class="chat-content">你好，刘备</p></span></div>-->
                        <!--<div class="buddy "><span><img class="avatar" src="__STATIC__/img/girl.jpeg" ></span><span><p class="nick-name">刘备</p><p class="chat-content">你好，张飞</p></span></div>-->

                        <!--<div class="myself" ><span><img class="myimg" src="__STATIC__/img/girl.jpeg" ></span><span><p class="nick-name">张飞</p><p class="chat-content">你好，刘备</p></span></div>-->
                        <!--<div class="buddy "><span><img class="avatar" src="__STATIC__/img/girl.jpeg" ></span><span><p class="nick-name">刘备</p><p class="chat-content">你好，张飞</p></span></div>-->


                        <!--<div class="myself" ><span><img class="myimg" src="__STATIC__/img/girl.jpeg" ></span><span><p class="nick-name">张飞</p><p class="chat-content">你好，刘备</p></span></div>-->
                        <!--<div class="buddy "><span><img class="avatar" src="__STATIC__/img/girl.jpeg" ></span><span><p class="nick-name">刘备</p><p class="chat-content">你好，张飞</p></span></div>-->


                        <!--<div class="myself" ><span><img class="myimg" src="__STATIC__/img/girl.jpeg" ></span><span><p class="nick-name">张飞</p><p class="chat-content">你好，刘备</p></span></div>-->
                        <!--<div class="buddy "><span><img class="avatar" src="__STATIC__/img/girl.jpeg" ></span><span><p class="nick-name">刘备</p><p class="chat-content">你好，张飞</p></span></div>-->


                        <!--<div class="myself" ><span><img class="myimg" src="__STATIC__/img/girl.jpeg" ></span><span><p class="nick-name">张飞</p><p class="chat-content">你好，刘备</p></span></div>-->
                        <!--<div class="buddy "><span><img class="avatar" src="__STATIC__/img/girl.jpeg" ></span><span><p class="nick-name">刘备</p><p class="chat-content">你好，张飞</p></span></div>-->


                        <!--<div class="myself" ><span><img class="myimg" src="__STATIC__/img/girl.jpeg" ></span><span><p class="nick-name">张飞</p><p class="chat-content">你好，刘备</p></span></div>-->
                        <!--<div class="buddy "><span><img class="avatar" src="__STATIC__/img/girl.jpeg" ></span><span><p class="nick-name">刘备</p><p class="chat-content">你好，张飞11</p></span></div>-->
                    </div>
                </div>

                <footer class="panel-footer" >
                    <div class="chat-toolbar">
                        <div class="add-face"></span><img src="__STATIC__/img/add_face.png" /></div>
                        <div contenteditable="true" class="input" ></div>
                        <button onclick="send1()"  class="chat-btn">
                            <span >发送</span>
                        </button>
                    </div>
                </footer>

            </div>





    </div>
</div>

<script src="__STATIC__/js/mSlider.js" type="text/javascript"></script>

<script src="__STATIC__/js/jquery.min.js" type="text/javascript"></script>

<script type="text/javascript">

    //给好友列表中的每一个好友绑定点击事件，点击创建一个聊天面板，切换聊天的面板及发送对象的名字
    function li_click(){
        $(".user-list").find("li").each(function(){
            $(this).click(function(){
                $(".chat-container").hide();
                var user = $(this).data("user");
                var userinfo = user.split("#");
                var uid=userinfo[0];//uid
                var name=userinfo[1];//昵称
                if($("div").is("."+uid)){
                    $("."+uid).css("display","block");
                }else{
                    $(".panel-body-container").append("<div class='panel-body chat-container "+uid+"' ></div>");
                }

                //出现滑动条时，让滑动条滑动到底部
                var div = $(".panel-body-container")[0];
                div.scrollTop = div.scrollHeight;

                $(this).children("i").remove();
                $("#towho").val(user);
                $(".chat-panel .panel-title").html(name);
            });
        });
    }

    var my_uid = "{$user.uid}";//我的uid

    var my_name = "{$user.name}";//我的头像

    var my_avatar = "__STATIC__/head/{$user.avatar}.jpg";//我的头像

    var websocket = null;

    //判断当前浏览器是否支持WebSocket
    if ('WebSocket' in window) {
        websocket = new WebSocket("ws://127.0.0.1:2346/");
    } else {
        alert('当前浏览器 Not support websocket');
    }

    //连接发生错误的回调方法
    websocket.onerror = function() {
        console.log("WebSocket连接发生错误");
    };

    //连接成功建立的回调方法
    websocket.onopen = function() {
        console.log("WebSocket连接成功");
        websocket.send("{$user.uid}"+"#"+"{$user.name}"+"#"+"{$user.avatar}");
        console.log("给服务端发送一个字符串："+"{$user.uid}"+"#"+"{$user.name}"+"#"+"{$user.avatar}");
    };

    //接收到消息的回调方法
    websocket.onmessage = function(event) {

        var info=event.data;
        var start = info.indexOf(":");
        var who = info.substring(0,start);
        var users_str = info.substr(start+1,info.length);
        //有新的好友上线或者下线
        if(who=="all"){
            //更新侧边朋友列表
            var users_obj = eval('(' + users_str + ')');
            var users_arr = [];
            for(var user in users_obj){
                users_arr.push(user);
                //如果有好友不在好友列表中，就添加到好友列表
                var userinfo = user.split("#");
                var uid = userinfo[0];
                var name=userinfo[1];//昵称
                var avatar="__STATIC__/head/"+userinfo[2]+".jpg";//头像

                if($(".user-list").find("."+uid).length==0){
                    if(uid!=my_uid){
                        $(".user-list").append("<li  class='list-item "+uid+"' data-user='"+user+"' ><div class='avatar'><img src='"+avatar+"'></div><p class='nick-name'>"+name+"</p></li>");
                        $(".chat-container").html("已经有好友上线了，点击好友头像开始聊天吧！");
                    }
                }
            }

            //如果有好友关闭连接，那么刷新好友列表
            if($(".user-list").find("li").length>0){
                $(".user-list").find("li").each(function(){
                    var dt=$(this);
                    var user = dt.data("user");
                    if($.inArray(user,users_arr)==-1){
                        dt.remove();
                    }
                });
            }

            li_click();//绑定点击事件
        }else{
            var message = info.substr(start+1,info.length);
            var userinfo = who.split("#");
            var uid = userinfo[0];//uid
            var name=userinfo[1];//昵称
            var avatar="__STATIC__/head/"+userinfo[2]+".jpg";//头像
            //如果页面上没有消息面板就创建一个消息面板，填入消息，在头像旁边显示数字1
            if(!$("div").is("."+uid)){
                $(".panel-body-container").append("<div class='panel-body chat-container "+uid+"' style='display:none'>"+"<div class='buddy'><span><img class='avatar' src='"+avatar+"' ></span><span><p class='nick-name'>"+name+"</p><p class='chat-content'>"+message+"</p></span></div>"+"</div>");
                $(".user-list").find("li").each(function(){
                    if($(this).data("user").indexOf(uid)>=0){
                        $(this).find(".nick-name").after("<i class='badge'>1</i>");
                    }
                });
            }else{
                //如果页面上已经有了消息面板就直接填入头像和消息,同时判断是不是当前聊天的用户，不是的话，在头像旁边显示数字加1
                $(".chat-panel ."+uid).append("<div class='buddy'><span><img class='avatar' src='"+avatar+"' ></span><span><p class='nick-name'>"+name+"</p><p class='chat-content'>"+message+"</p></span></div>");

                if($("#towho").val().indexOf(uid)<0){
                    $(".user-list").find("li").each(function(){
                        var dt = $(this);
                        if(dt.data("user").indexOf(uid)!=-1){
                            if(dt.find(".badge").length>0){
                                var num_html = dt.find(".badge").html();
                                var num = parseInt(num_html);
                                num++;
                                dt.find(".badge").html(num);
                            }else{
                                dt.find(".nick-name").after("<i class='badge'>1</i>");
                            }
                        }
                    });
                }else{
                    //出现滑动条时，让滑动条滑动到底部
                    var div = $(".panel-body-container")[0];
                    div.scrollTop = div.scrollHeight;
                }
            }


        }
    };

    //连接关闭的回调方法
    websocket.onclose = function() {
        console.log("WebSocket连接关闭");
    };

    //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
    window.onbeforeunload = function() {
        console.log("close");
        websocket.close();
    };

    //点击按钮发送消息
    function send1(){
        var message = $(".chat-toolbar .input").html();
        websocket.send($("#towho").val()+":"+message);
        var userinfo = $("#towho").val().split("#");
        var uid = userinfo[0];//uid

        $(".chat-panel ."+uid).append("<div class='myself' ><span><img class='myimg' src='"+my_avatar+"' ></span><span><p class='nick-name'>"+my_name+"</p><p class='chat-content'>"+message+"</p></span></div>");
        $(".chat-toolbar .input").html("");

        //出现滑动条时，让滑动条滑动到底部
        var div = $(".panel-body-container")[0];
        div.scrollTop = div.scrollHeight;

    }

    $(function(){
        //移动端使用touchend
        var event = navigator.userAgent.match(/(iPhone|iPod|Android|ios)/i) ? 'touchend' : 'click';

        // 选择器
        var Q = function (id) {
            return document.getElementById(id)
        };

        //右
        var _right = new mSlider({
            dom: ".layer-right",
            direction: "right"
        });

        Q("btnRight").addEventListener(event, function (e) {
            _right.open();
        });

        //实例化表情
        var t = ["[微笑]", "[嘻嘻]", "[哈哈]", "[可爱]", "[可怜]", "[挖鼻]", "[吃惊]", "[害羞]", "[挤眼]", "[闭嘴]", "[鄙视]", "[爱你]",
            "[泪]", "[偷笑]", "[亲亲]", "[生病]", "[太开心]", "[白眼]", "[右哼哼]", "[左哼哼]", "[嘘]", "[衰]",
            "[委屈]", "[吐]", "[哈欠]", "[抱抱]", "[怒]", "[疑问]", "[馋嘴]", "[拜拜]", "[思考]", "[汗]", "[困]",
            "[睡]", "[钱]", "[失望]", "[酷]", "[色]", "[哼]", "[鼓掌]", "[晕]", "[悲伤]",
            "[抓狂]", "[黑线]", "[阴险]", "[怒骂]", "[互粉]", "[心]", "[伤心]",
            "[猪头]", "[熊猫]", "[兔子]", "[ok]", "[耶]", "[good]", "[NO]", "[赞]",
            "[来]", "[弱]", "[草泥马]", "[神马]", "[囧]", "[浮云]", "[给力]",
            "[围观]", "[威武]", "[奥特曼]", "[礼物]", "[钟]", "[话筒]", "[蜡烛]", "[蛋糕]", "[小鸡]"];

        var toolbar = $(".chat-toolbar");
        var ul = $("<ul></ul>");
        var ulHtml = "";
        for(var i = 0,l= t.length;i<l;i++){
            ulHtml +="<li><img alt='"+t[i]+"' title='"+t[i]+"' src='__STATIC__/face/"+i+".gif'  /></li>";
        }
        ul.html(ulHtml);
        toolbar.append(ul);
        $(".chat-toolbar .add-face").click(function(){
            $(".chat-toolbar ul").show();
        });

        var input = $(".chat-toolbar .input");
        $(".chat-toolbar ul").find("li").click(function(){
                var obj =$(this);
                $(".chat-toolbar ul").hide();
                var src=obj.find("img").attr("src");
                var input_html = input.html();
                input.html(input_html+"<img src='"+src+"'>");
        });
        $(".chat-toolbar ul").mouseleave(function(){
            $(".chat-toolbar ul").hide();
        });


        li_click();


    });


</script>



</body>
</html>